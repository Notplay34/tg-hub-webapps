# План работ до полного релиза YouHub (TG Hub)

Обзор сделан по состоянию на февраль 2025. Цель — привести проект к состоянию «полный релиз»: стабильная работа, понятная документация, минимальные риски для пользователя.

---

## 1. Текущее состояние

### Что уже есть и работает

| Область | Статус |
|--------|--------|
| **Архитектура** | Единый Hub (Web App) + FastAPI + Telegram-бот. Один фронт в `hub/`, один бэкенд в `api/main.py`. |
| **Задачи** | CRUD, дедлайны, приоритеты, напоминания (бот), повторения, привязка к человеку, таймлайн. |
| **Картотека** | Люди, поля, группы, связи, заметки, связь с задачами и знаниями. |
| **База знаний** | CRUD, теги, поиск, привязка к человеку. |
| **Финансы** | Транзакции (доход/расход/сбережения), цели (Сбережения / Из остатка), лимиты по категориям, сводка по месяцам, перенос остатка. |
| **ИИ-ассистент** | Чат с сжатием истории, команды по задачам/людям/знаниям/финансам. |
| **Деплой** | DEPLOY.md, systemd, nginx, скрипты в `deploy/`. |
| **Фронт** | Touch-цели 44–48px, единые токены в CSS, модалки, лимиты. |

### Что не соответствует реальности или устарело

- **README.md** — описан старый вариант (отдельные Web Apps tasks/people, GitHub Pages). Сейчас один Hub по `WEBAPP_HUB_URL`, финансы и ИИ не описаны.
- **deploy/README.md** — конфиг nginx для `/tasks/` и `/people/`, в проде используется единый `/hub/`. Упоминаются `WEBAPP_TASKS_URL` / `WEBAPP_PEOPLE_URL`, в боте используется только `WEBAPP_HUB_URL`.
- Папки **tasks/, people/, knowledge/** — отдельные app.js/index.html; не ясно, используются ли (похоже на старые/запасные сборки). В проде отдаётся только `hub/`.

### Чего нет для «полного релиза»

1. **Документация** — актуальное описание продукта, установки, деплоя и конфига под текущую архитектуру.
2. **Тесты** — нет ни unit, ни интеграционных; любой рефакторинг рискованный.
3. **Безопасность** — `X-User-Id` передаётся с фронта; API ему доверяет. Для Web App из Telegram желательна проверка `initData` на бэкенде.
4. **Резервное копирование** — нет скрипта/инструкции по бэкапу SQLite (`data/hub.db`).
5. **Надёжность** — нет health-check/мониторинга (кроме `/api/health`), нет алертов при падении.
6. **Миграции БД** — схема создаётся в `init_db()` при старте; при изменении таблиц нет версионирования и миграций.
7. **Экспорт данных** — пользователь не может выгрузить свои задачи/людей/финансы (lock-in).

---

## 2. План по этапам (до релиза)

### Фаза 0: Привести документацию в порядок (1–2 дня)

**Цель:** любой новый разработчик или ты через полгода мог по README и deploy-докам поднять проект и задеплоить.

| # | Задача | Результат |
|---|--------|-----------|
| 0.1 | Обновить **README.md** | Описание: один Hub, разделы Задачи / Картотека / База знаний / Финансы / ИИ. Быстрый старт, структура папок (hub, api, bot), ссылка на DEPLOY.md и RELEASE_PLAN.md. |
| 0.2 | Обновить **deploy/README.md** | Nginx под один `location /hub/` и проксирование `/api/` на uvicorn. Переменные окружения: BOT_TOKEN, WEBAPP_HUB_URL, опционально ключи ИИ. Шаги: установка, .env, nginx, systemd, SSL. |
| 0.3 | Привести **.env.example** в актуальность | Только используемые переменные (BOT_TOKEN, WEBAPP_HUB_URL, ключи ИИ). Убрать WEBAPP_TASKS_URL / WEBAPP_PEOPLE_URL, если не используются. |
| 0.4 | Решить про tasks/people/knowledge | Либо удалить, либо кратко описать в README («legacy/standalone, не используются в основном сценарии»). |

**Критерий готовности:** по README + deploy/README можно развернуть с нуля и открыть Hub из бота.

---

### Фаза 1: Стабильность и безопасность (2–4 дня)

**Цель:** минимальная защита от подделки user_id и возможность не сломать всё при изменениях в API/БД.

| # | Задача | Результат |
|---|--------|-----------|
| 1.1 | **Валидация Telegram initData в API** | Эндпоинт или middleware: проверка подписи `initData` (алгоритм из доки Telegram), извлечение `user.id` и установка `X-User-Id` на сервере. Запросы без валидного initData (или без Web App) — 401 или отдельный «тестовый» режим по флагу. |
| 1.2 | **Health-check** | Уже есть `/api/health`. При желании: проверка доступности БД (SELECT 1) и возврат 503 при недоступности. |
| 1.3 | **Резервное копирование** | Скрипт `scripts/backup_db.sh` (или .ps1 для Windows): копирование `data/hub.db` в `backups/` с датой в имени. Кратко в DEPLOY.md или deploy/README: «рекомендуется cron раз в день». |
| 1.4 | **Логирование** | В API: логировать ошибки (и при желании важные действия без персональных данных). В боте — уже есть logging; при падении напоминаний — явный лог. |

**Критерий готовности:** запросы к API с поддельным user_id не принимаются (или только в dev); есть бэкап и понятно, куда смотреть при ошибках.

---

### Фаза 2: Тесты (2–3 дня)

**Цель:** не бояться менять API и бота; регрессии будут видны.

| # | Задача | Результат |
|---|--------|-----------|
| 2.1 | **Среда для тестов** | pytest, pytest-asyncio. Папка `tests/`, conftest.py с фикстурой «тестовая БД в памяти» (или временный файл) и фикстурой клиента FastAPI. |
| 2.2 | **Тесты API** | Хотя бы по одному сценарию на модуль: задачи (создать → получить → обновить → удалить), люди, знания, финансы (транзакция, цель, лимит), health. Заголовок `X-User-Id` задаётся в тестах (пока без проверки initData). |
| 2.3 | **Запуск в CI** | GitHub Actions (или аналог): на push запуск pytest. В README указать: «тесты: pytest». |

**Критерий готовности:** `pytest` проходит; при изменении эндпоинта падающий тест покажет регрессию.

---

### Фаза 3: Миграции БД и экспорт (1–2 дня)

**Цель:** в будущем безопасно менять схему; пользователь может забрать свои данные.

| # | Задача | Результат |
|---|--------|-----------|
| 3.1 | **Версия схемы** | Таблица `schema_version` (version INT) или аналогично. При старте API: если версия < текущей — выполнить скрипты миграций (отдельные SQL-файлы в `migrations/` или один блок в коде для малых изменений). |
| 3.2 | **Экспорт данных** | Эндпоинт `GET /api/export` (или `/api/backup`) с заголовком `X-User-Id`: возврат JSON со всеми данными пользователя (tasks, people, knowledge, finance, goals, limits). В Hub — кнопка «Экспорт данных» (скачивание файла). Ограничить частоту вызовов (например, раз в час на user_id). |

**Критерий готовности:** добавление нового поля в таблицу делается через миграцию; пользователь может скачать свой дамп.

---

### Фаза 4: Фронт и UX (по приоритету)

**Цель:** доделать то, что реально мешает или обещано.

| # | Задача | Результат |
|---|--------|-----------|
| 4.1 | **Обработка офлайна** | При отсутствии сети — сообщение «Нет соединения», кнопка «Повторить». Не падать молча при fetch. |
| 4.2 | **Загрузка/сохранение** | На кнопках «Сохранить» при долгом ответе — индикатор (дизейбл кнопки или спиннер), чтобы не было двойной отправки. |
| 4.3 | **Финансы: подсказки** | В форме лимитов — подсказка «Категория как в расходах» или автоподстановка категорий из существующих расходов (опционально). |
| 4.4 | **Редактирование транзакции** | Уже есть; проверить сценарий «изменить дату/сумму/категорию» и что сводка/лимиты пересчитываются. |

Делать в том объёме, в котором нужно для комфорта; не обязательно всё в один релиз.

---

### Фаза 5: Релиз и пост-релиз

| # | Задача | Результат |
|---|--------|-----------|
| 5.1 | **Версионирование** | В API: версия в ответе `/api/health` (например `"version": "1.0.0"`). В Hub — не обязательно, но можно вывести в футере или «О приложении». |
| 5.2 | **Changelog** | Файл CHANGELOG.md: версия, дата, список изменений (для себя и пользователей). |
| 5.3 | **Публичный релиз** | По желанию: краткое описание в канале/чате, ссылка на бота. Сбор обратной связи. |
| 5.4 | **Мониторинг** | Опционально: uptime-бот или простой cron на `curl /api/health` с алертом при не 200. |

---

## 3. Приоритеты (что делать первым)

Рекомендуемый порядок:

1. **Фаза 0** — без актуальной документации релизовать тяжело.
2. **Фаза 1.3** (бэкап) — быстро и сильно снижает риск потери данных.
3. **Фаза 1.1** (валидация initData) — если приложение уже открыто не только тебе; иначе можно сдвинуть после тестов.
4. **Фаза 2** — тесты перед дальнейшим усложнением (миграции, экспорт).
5. **Фаза 3** — миграции + экспорт.
6. **Фаза 4** — выборочно по ощущениям от использования.
7. **Фаза 5** — когда будешь готов назвать версию 1.0.

---

## 4. Краткий чеклист «Готов к релизу»

- [ ] README и deploy-документация соответствуют текущей сборке (один Hub, hub + api + bot).
- [ ] Есть резервное копирование БД и инструкция.
- [ ] API проверяет Telegram initData или явно помечен «dev-режим».
- [ ] Есть хотя бы базовые тесты API и они зелёные.
- [ ] Пользователь может экспортировать свои данные.
- [ ] На критичных действиях есть индикация загрузки и обработка ошибок сети.
- [ ] Версия и changelog зафиксированы.

После этого можно считать релиз состоявшимся и итерировать по обратной связи.

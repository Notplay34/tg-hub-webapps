## TG Hub — архитектура

TG Hub состоит из двух основных частей:

- **Telegram‑бот (`tg_hub_bot/`)**
- **HTTP API (`api/`)**

Фронтенд (`hub/`) обращается к API, а бот использует то же API и общую базу данных `data/hub.db`.

---

## Слои Telegram‑бота (`tg_hub_bot/`)

Бот организован по классической многослойной схеме:

- **Handlers (`tg_hub_bot/handlers/`)**  
  Чистая Telegram‑логика: принимают апдейты, читают команды и текст, вызывают сервисы и формируют ответы пользователю.

- **Services (`tg_hub_bot/services/`)**  
  Бизнес‑логика: работа с напоминаниями, задачами, контактами, интеграция с AI, интерпретация команд пользователя.

- **Repositories (`tg_hub_bot/repositories/`)**
  Доступ к данным только через интерфейсы (TaskRepository и др.). Содержат SQL и маппинг в доменные модели. Получают соединение через **DatabaseProvider** из `storage/`; handlers и services не создают соединений и не знают о типе БД.

- **Storage (`storage/`)**
  - **DatabaseProvider** — единая точка создания соединений с БД (используется при старте приложения).
  - **bootstrap** — фабрики `get_database_provider()`, `get_tasks_repo()`; репозитории получают провайдер и инкапсулируют всю работу с БД.
  - Замена SQLite на PostgreSQL: новая реализация провайдера + репозиториев без изменения handlers и services.

- **Models (`tg_hub_bot/models/`)**  
  Доменные модели (dataclasses/Pydantic): `TaskSummary`, `ReminderTask` и др.  
  Используются сервисами и репозиториями вместо «сырых» dict.

- **Keyboards (`tg_hub_bot/keyboards/`)**  
  Генерация всех inline/Reply‑клавиатур для Telegram.

- **Scheduler (`tg_hub_bot/scheduler.py`)**  
  Обёртка над APScheduler:
  - `create_scheduler(reminders_service)` — создаёт экземпляр планировщика и регистрирует задачи.
  - `start_scheduler(scheduler)` — запускает планировщик.

- **App (`tg_hub_bot/app.py`)**  
  Точка сборки бота:
  - инициализация `Bot`, `Dispatcher`, scheduler;
  - создание экземпляров репозиториев, сервисов, AI‑клиента;
  - регистрация handlers и запуск polling.

**Entrypoint**: корневой `bot.py` — тонкий файл, который импортирует `run()` из `tg_hub_bot.app` и запускает его через `asyncio.run()`.

---

## AI‑слой API (`api/`)

Основное приложение FastAPI живёт в файле `api/main.py`.  
Для работы с AI и историей диалога используются отдельные слои:

- **AI‑клиент (`api/services/ai_client.py`)**
  - Инкапсулирует выбор провайдера (`OpenRouter`, `vsellm`, `Google`, `Yandex`) и конфигурацию клиентов.
  - Предоставляет единый интерфейс:
    - `async def chat(messages: list[dict], model_hint: str | None, ...) -> str`
  - Скрывает детали работы с моделями, температурами, токенами и т.п.

- **Репозиторий истории чата (`api/repositories/chat_history.py`)**
  - Отвечает за таблицу `chat_history` в SQLite:
    - чтение и запись сообщений;
    - выборка последних сообщений для контекста;
    - сжатие истории и удаление старых записей;
    - утилиты `append_turn_and_trim`, `get_recent_history`, `clear_history` и др.

- **Маршрут `/api/chat` (`api/main.py`)**
  - Собирает контекст: задачи, контакты, знания, финансы, лимиты.
  - Получает историю диалога из `ChatHistoryRepository`.
  - Формирует системный промпт и список сообщений.
  - Вызывает `AiClient.chat(...)` и возвращает ответ.
  - Сохраняет новый поворот диалога через репозиторий истории.

---

## Планировщик и память чата

- **Планировщик (бот)**
  - Реализован в `tg_hub_bot/scheduler.py`.
  - Отвечает за напоминания и периодические задачи.
  - Может быть вынесен в отдельный процесс/воркер (entrypoint, отдельный `uvicorn`/`python`).

- **Память чата (API)**
  - Константы в `api/main.py`:
    - `CHAT_HISTORY_LIMIT` — сколько последних сообщений хранится «как есть»;
    - `CHAT_SUMMARY_CHUNK` — сколько старых сообщений сжимается за раз;
    - `CHAT_SUMMARY_THRESHOLD` — порог, после которого запускается сжатие.
  - Функция `maybe_summarize_chat(user_id)`:
    - если история слишком длинная, запрашивает у AI краткое резюме старых сообщений;
    - сохраняет резюме как системное сообщение;
    - удаляет исходные старые записи через репозиторий истории.

---

## Точки расширения

- **Подмена AI‑провайдера**
  - Реализуется через замену реализации в `api/services/ai_client.py`.
  - Интерфейс `chat(...)` остаётся тем же для `api/main.py`.

- **Замена/расширение БД**
  - Сейчас используется SQLite (`aiosqlite`) и файл `data/hub.db`.
  - **Бот**: SQLite полностью изолирован от `bot.py` и handlers. Соединения создаёт только `storage.database.AiosqliteDatabaseProvider`; репозитории (`TaskRepository`) получают провайдер и содержат весь SQL. Для перехода на PostgreSQL: реализовать `PostgresDatabaseProvider` и, при необходимости, `PostgresTaskRepository`; handlers и services не меняются.
  - **API**: в `api/main.py` по-прежнему есть прямой доступ к БД в эндпоинтах (tasks, people, knowledge, finance и т.д.); для полной изоляции можно ввести такой же слой провайдера и репозиториев.
  - Репозитории позволяют добавлять новые таблицы/сервисы без изменения хэндлеров.

- **Отделение планировщика**
  - `tg_hub_bot/scheduler.py` инициализируется в `tg_hub_bot/app.py`.
  - Можно вынести запуск scheduler в отдельный процесс (например, отдельный сервис systemd или контейнер), который использует те же репозитории и модели.

- **Расширение доменной модели**
  - Для задач/людей/финансов можно добавлять новые поля:
    - в Pydantic‑модели `Task`, `Person`, `Finance*` в `api/main.py`;
    - в доменные модели и репозитории бота.
  - API и бот продолжают общаться через стабильные модели и сервисы.

